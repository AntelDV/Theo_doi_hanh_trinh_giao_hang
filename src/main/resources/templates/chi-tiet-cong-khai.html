<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hành trình Đơn hàng</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    
    <style>
        body { background-color: var(--light-bg); }
        .timeline { list-style: none; padding: 0; position: relative; }
        .timeline::before {
            content: ''; position: absolute; top: 0; bottom: 0; width: 3px;
            background: var(--border-color); left: 30px; margin-left: -1.5px;
        }
        .timeline-item { margin-bottom: 20px; position: relative; padding-left: 60px; }
        .timeline-item::before { /* Icon circle */
            content: ''; background: var(--secondary-color); position: absolute;
            left: 30px; top: 5px; width: 15px; height: 15px;
            border-radius: 50%; margin-left: -7.5px; z-index: 1;
        }
        /* Các trạng thái đặc biệt */
        .timeline-item.status-success::before { background: var(--success); }
        .timeline-item.status-danger::before { background: var(--danger); }
        .timeline-item.status-current::before { /* Trạng thái mới nhất */
            background: var(--primary-color); border: 3px solid #fff; 
            box-shadow: 0 0 0 3px var(--primary-color); 
            width: 20px; height: 20px; margin-left: -10px;
        }

        .timeline-content {
            background: var(--white); border-radius: 0.35rem; padding: 15px;
            border: 1px solid var(--border-color); position: relative;
        }
        .timeline-content::before { /* Mũi tên tam giác */
            content: ''; position: absolute; top: 10px; left: -10px;
            border-top: 10px solid transparent; border-bottom: 10px solid transparent;
            border-right: 10px solid var(--border-color);
        }
        .timeline-content::after {
            content: ''; position: absolute; top: 11px; left: -9px;
            border-top: 9px solid transparent; border-bottom: 9px solid transparent;
            border-right: 9px solid #fff;
        }

        .timeline-time { font-size: 0.85em; color: var(--secondary-color); display: block; margin-bottom: 5px;}
        .timeline-status { font-weight: 600; color: var(--dark-text); margin-bottom: 5px;}
        .timeline-note { font-size: 0.9em; color: #555; }
        
        /* Container cho trang công khai */
        .tracking-container {
            max-width: 900px;
            margin: 2.5rem auto;
            padding: 0 1.5rem;
        }
        .page-header {
            font-size: 1.8rem; font-weight: 600;
            margin-bottom: 2rem; color: var(--dark-text);
        }
    </style>
</head>

<body>
    <div class="tracking-container">
        
        <div class="text-center mb-4">
             <a th:href="@{/tra-cuu}" class="btn btn-secondary"> <i class="fas fa-arrow-left"></i> Tra cứu đơn khác</a>
        </div>

        <h1 class="page-header" th:text="'Hành trình Đơn hàng: ' + ${donHang.maVanDon}">Hành trình Đơn hàng</h1>

        <div class="row">
            <div class="col-lg-5 mb-4">
                <div class="card shadow">
                    <div class="card-header py-3"><h6 class="m-0 font-weight-bold text-primary">Thông tin Đơn hàng</h6></div>
                    <div class="card-body">
                        <p><strong>Mã vận đơn:</strong> <span th:text="${donHang.maVanDon}"></span></p>
                        <p><strong>Ngày tạo:</strong> <span th:text="${#dates.format(donHang.ngayTao, 'dd/MM/yyyy')}"></span></p>
                        <hr>
                        <p><strong>Từ:</strong> <span th:text="${donHang.diaChiLayHang.quanHuyen} + ', ' + ${donHang.diaChiLayHang.tinhTp}"></span></p>
                        <hr>
                        
                        <p>
                            <strong>Người nhận:</strong>
                            <span th:if="${donHang.tenNguoiNhan != null && #strings.length(donHang.tenNguoiNhan) > 2}"
                                  th:text="${#strings.substring(donHang.tenNguoiNhan, 0, 1) + '***' + #strings.substring(donHang.tenNguoiNhan, #strings.length(donHang.tenNguoiNhan) - 1, #strings.length(donHang.tenNguoiNhan))}">
                            </span>
                            <span th:if="${donHang.tenNguoiNhan == null || #strings.length(donHang.tenNguoiNhan) <= 2}">***</span>
                        </p>
                        <p>
                            <strong>Đến:</strong>
                            <span th:if="${donHang.diaChiGiaoHang != null && #strings.contains(donHang.diaChiGiaoHang, ',')}"
                                  th:with="parts=${#strings.arraySplit(donHang.diaChiGiaoHang, ',')}"
                                  th:text="${parts.length > 2 ? '******, ' + parts[parts.length-2] + ', ' + parts[parts.length-1] : '******, ' + donHang.diaChiGiaoHang}">
                            </span>
                            <span th:if="${donHang.diaChiGiaoHang != null && !#strings.contains(donHang.diaChiGiaoHang, ',')}">******</span>
                            <span th:if="${donHang.diaChiGiaoHang == null}">[Chưa rõ]</span>
                        </p>
                        <hr>
                        <p><strong>Thu hộ (COD):</strong> <span th:text="${#numbers.formatCurrency(donHang.thanhToan.tongTienCod)}"></span></p>
                    </div>
                </div>
            </div>

            <div class="col-lg-7 mb-4">
                <div class="card shadow">
                    <div class="card-header py-3"><h6 class="m-0 font-weight-bold text-primary">Hành trình Đơn hàng</h6></div>
                    <div class="card-body">
                        <ul class="timeline">
                            <tr th:if="${#lists.isEmpty(donHang.hanhTrinh)}">
                                <p>Chưa có thông tin hành trình.</p>
                            </tr>
                            <li th:each="ht, iterStat : ${donHang.hanhTrinh}" 
                                class="timeline-item"
                                th:classappend="${iterStat.first ? 'status-current' : ''} + 
                                                (${#strings.containsIgnoreCase(ht.trangThai.tenTrangThai, 'thành công')} ? 'status-success' : '') +
                                                (${#strings.containsIgnoreCase(ht.trangThai.tenTrangThai, 'thất bại') or #strings.containsIgnoreCase(ht.trangThai.tenTrangThai, 'hủy')} ? 'status-danger' : '')">
                                <div class="timeline-content">
                                    <span class="timeline-time"><i class="far fa-clock"></i> <span th:text="${#dates.format(ht.thoiGianCapNhat, 'dd/MM/yyyy HH:mm')}"></span></span>
                                    <p class="timeline-status" th:text="${ht.trangThai.tenTrangThai}"></p>
                                    <p class="timeline-note" th:if="${ht.ghiChuNhanVien}" th:text="${ht.ghiChuNhanVien}"></p>
                                    </div>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>